<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æŠ•è³‡ãƒ¯ã‚«ãƒ¼ãƒ«å› ver0.1</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#101826;
      --panel2:#0f1724;
      --text:#e6eefc;
      --muted:#9fb0c8;
      --line:rgba(255,255,255,.08);
      --good:#36d399;
      --bad:#ff6b6b;
      --accent:#6ea8ff;
      --accent2:#8b5cf6;
      --warn:#fbbf24;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --tap:52px;
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(110,168,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 20%, rgba(139,92,246,.22), transparent 55%),
        radial-gradient(700px 500px at 40% 120%, rgba(54,211,153,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    .safe{
      padding: max(16px, env(safe-area-inset-top)) 16px max(18px, env(safe-area-inset-bottom)) 16px;
      max-width: 720px;
      margin: 0 auto;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(110,168,255,1), rgba(139,92,246,1));
      box-shadow: 0 10px 24px rgba(110,168,255,.2);
      display:grid;place-items:center;
      font-weight:800;
      letter-spacing:.5px;
    }
    .brand h1{
      font-size:16px;
      margin:0;
      line-height:1.2;
    }
    .brand small{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }

    .top-actions{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .pill{
      border:1px solid var(--line);
      background: rgba(16,24,38,.65);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
    }

    .tabs{
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap:10px;
      margin: 10px 0 16px;
    }
    .tab{
      min-height: var(--tap);
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(16,24,38,.55);
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow: none;
      cursor:pointer;
    }
    .tab[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(110,168,255,.22), rgba(139,92,246,.18));
      color: var(--text);
      border-color: rgba(110,168,255,.35);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }

    .card{
      background: rgba(16,24,38,.65);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .card + .card{ margin-top: 12px; }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .grow{ flex:1; min-width: 220px; }
    .label{ color: var(--muted); font-size:12px; }
    .value{ font-size:18px; font-weight:800; letter-spacing:.2px; }

    .kpis{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .kpi{
      background: rgba(15,23,36,.7);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding: 12px;
    }
    .kpi .label{ margin-bottom:6px; display:flex; align-items:center; gap:8px;}
    .kpi .value{ font-size:20px; }
    .kpi .sub{ color:var(--muted); font-size:12px; margin-top:6px; }

    button{ font-family: inherit; border:none; cursor:pointer; }
    .btn{
      min-height: var(--tap);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      font-size: 14px;
      color: var(--text);
      background: rgba(15,23,36,.9);
      border:1px solid var(--line);
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(135deg, rgba(110,168,255,1), rgba(139,92,246,1));
      border: none;
    }
    .btn-ghost{
      background: transparent;
      border:1px solid var(--line);
      color: var(--muted);
      box-shadow: none;
    }
    .btn-danger{
      background: rgba(255,107,107,.12);
      border:1px solid rgba(255,107,107,.35);
      color: #ffd2d2;
      box-shadow:none;
    }
    .btn-mini{
      min-height: 42px;
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 12px;
      box-shadow:none;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(11,15,20,.55);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::placeholder, textarea::placeholder{ color: rgba(159,176,200,.65); }
    textarea{ min-height: 86px; resize: vertical; }

    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }

    .invest-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .big{
      min-height: 64px;
      font-size: 16px;
      border-radius: 16px;
    }
    .big.plus{
      background: linear-gradient(135deg, rgba(54,211,153,.9), rgba(110,168,255,.9));
      border: none;
    }
    .big.plus2{
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(139,92,246,.75));
      border: none;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .item{
      background: rgba(15,23,36,.6);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
    }
    .item-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(11,15,20,.5);
      border:1px solid var(--line);
      white-space: nowrap;
    }
    .mono{ font-variant-numeric: tabular-nums; }
    .right{ text-align:right; }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }
    .muted{ color: var(--muted); }
    .hr{ height:1px; background: var(--line); margin: 10px 0; }

    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      z-index: 99;
    }
    .modal{
      width: min(720px, 100%);
      background: rgba(16,24,38,.92);
      border: 1px solid var(--line);
      border-radius: 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      padding: 14px;
      backdrop-filter: blur(12px);
      transform: translateY(10px);
    }
    .modal h3{ margin: 4px 0 10px; font-size: 15px; }
    .modal .actions{ display:flex; gap:10px; margin-top: 12px; }

    /* --- mobile modal fix (iPhone/Safari safe-area & buttons) --- */
    .modal-backdrop{
      padding: calc(18px + env(safe-area-inset-bottom)) 18px 18px 18px;
    }
    .modal{
      max-height: calc(100vh - 36px - env(safe-area-inset-top));
      overflow: auto;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }
    .modal .actions{
      flex-wrap: wrap;
    }
    .modal .actions .btn{
      min-width: 0;
      flex: 1;
    }
    @media (max-width: 420px){
      .modal .actions{
        flex-direction: column;
      }
    }
    /* --- end mobile modal fix --- */

    .view{ display:none; }
    .view.active{ display:block; }

    @media (max-width: 380px){
      .kpis{ grid-template-columns: 1fr; }
      .tabs{ gap:8px; }
      .tab{ font-size:12px; }
    }
  </style>
</head>

<body>
  <div class="safe">
    <header>
      <div class="brand">
        <div class="logo">æŠ•</div>
        <div>
          <h1>æŠ•è³‡ãƒ¯ã‚«ãƒ¼ãƒ«å› <small>ver0.1 / MVPï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</small></h1>
        </div>
      </div>
      <div class="top-actions">
        <div id="todayPill" class="pill mono"></div>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="ãƒ¡ã‚¤ãƒ³">
      <button class="tab" id="tabHome" role="tab" aria-selected="true" data-view="home">ğŸ  ãƒ›ãƒ¼ãƒ </button>
      <button class="tab" id="tabRun"  role="tab" aria-selected="false" data-view="run">â±ï¸ ç¨¼åƒ</button>
      <button class="tab" id="tabLogs" role="tab" aria-selected="false" data-view="logs">ğŸ“’ ãƒ­ã‚°</button>
    </nav>

    <!-- HOME -->
    <section id="viewHome" class="view active">
      <div class="card">
        <div class="row">
          <div class="grow">
            <div class="label">ä»Šæ—¥ã®çŠ¶æ…‹</div>
            <div id="homeStatus" class="value">æœªç¨¼åƒ</div>
            <div class="hint" id="homeStatusHint">åº—èˆ—ã‚’é¸ã‚“ã§ç¨¼åƒé–‹å§‹ã§ãã¾ã™ã€‚</div>
          </div>
          <div class="row" style="gap:8px; justify-content:flex-end;">
            <button class="btn btn-primary" id="btnSessionToggle">ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹</button>
            <button class="btn btn-ghost" id="btnOpenStart">å°ã‚’æ‰“ã¤</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="value">åº—èˆ—ç®¡ç†</div>
            <div class="hint">åº—èˆ—åãƒ»è²¸å‡ºï¼ˆ46/50ï¼‰ãƒ»è²¯ãƒ¡ãƒ€ãƒ«ã‚’ä¿å­˜ã—ã¾ã™ã€‚</div>
          </div>
          <button class="btn btn-mini" id="btnOpenShopModal">ï¼‹ åº—èˆ—è¿½åŠ </button>
        </div>
        <div class="hr"></div>
        <div id="shopList" class="list"></div>
        <div id="shopEmpty" class="hint" style="margin-top:10px; display:none;">
          ã¾ã åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹ åº—èˆ—è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>

      <div class="card">
        <div class="value">ç°¡æ˜“åˆ†æï¼ˆå…¨ãƒ­ã‚°ï¼‰</div>
        <div class="hint">å·®æšåˆè¨ˆ / å¹³å‡æ™‚çµ¦ / ç¨¼åƒæ™‚é–“åˆè¨ˆï¼ˆMVPï¼‰</div>
        <div class="hr"></div>
        <div class="kpis">
          <div class="kpi">
            <div class="label">ğŸ“Œ å·®æšåˆè¨ˆ</div>
            <div id="kpiTotalDiff" class="value mono">0æš</div>
            <div class="sub">å…¨æœŸé–“ï¼ˆä¿å­˜ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ï¼‰</div>
          </div>
          <div class="kpi">
            <div class="label">ğŸ’´ å¹³å‡æ™‚çµ¦</div>
            <div id="kpiAvgHourly" class="value mono">0å††/h</div>
            <div class="sub">å…¨æœŸé–“ï¼ˆä¿å­˜ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ï¼‰</div>
          </div>
          <div class="kpi">
            <div class="label">â³ ç¨¼åƒæ™‚é–“åˆè¨ˆ</div>
            <div id="kpiTotalTime" class="value mono">0:00</div>
            <div class="sub">å…¨æœŸé–“ï¼ˆä¿å­˜ãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ï¼‰</div>
          </div>
          <div class="kpi">
            <div class="label">ğŸ§¾ ãƒ­ã‚°ä»¶æ•°</div>
            <div id="kpiCount" class="value mono">0ä»¶</div>
            <div class="sub">å…¨æœŸé–“</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="value">ãƒ‡ãƒ¼ã‚¿</div>
            <div class="hint">localStorageã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚</div>
          </div>
          <button class="btn btn-danger btn-mini" id="btnResetAll">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
      </div>
    </section>

    <!-- RUN -->
    <section id="viewRun" class="view">
      <div class="card" id="runTopCard">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="label">ç¨¼åƒä¸­</div>
            <div id="runShopName" class="value">æœªé–‹å§‹</div>
            <div class="hint">
              <span class="muted">è²¸å‡º:</span> <span id="runUnit" class="mono">-</span>æš /
              <span class="muted">çµŒé:</span> <span id="runElapsed" class="mono">0:00:00</span>
            </div>
          </div>
          <div class="right">
            <div class="badge">ğŸ•’ é–‹å§‹ <span id="runStartAt" class="mono">-</span></div>
            <div style="height:8px"></div>
            <button class="btn btn-danger btn-mini" id="btnEndRun" disabled>ç¨¼åƒçµ‚äº†</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">ğŸ“¥ æŠ•è³‡ï¼ˆæšï¼‰</div>
            <div id="runInvestMedals" class="value mono">0æš</div>
            <div class="sub">ï¼ˆè²¯ãƒ¡ãƒ€ãƒ«å„ªå…ˆã§è‡ªå‹•æ¶ˆè²»ï¼‰</div>
          </div>
          <div class="kpi">
            <div class="label">ğŸ’µ ç¾é‡‘æŠ•è³‡ï¼ˆå††ï¼‰</div>
            <div id="runCashYen" class="value mono">0å††</div>
            <div class="sub">è²¸å‡º1å›=1000å††æ›ç®—</div>
          </div>
          <div class="kpi">
            <div class="label">ğŸ¦ æ®‹ã‚Šè²¯ãƒ¡ãƒ€ãƒ«</div>
            <div id="runShopMedals" class="value mono">0æš</div>
            <div class="sub">åº—èˆ—è¨­å®šã«åæ˜ ï¼ˆçµ‚äº†æ™‚ã«ç¢ºå®šï¼‰</div>
          </div>
          <div class="kpi">
            <div class="label">ğŸ“ˆ ç¾åœ¨ã®å·®æš</div>
            <div id="runLiveDiff" class="value mono">0æš</div>
            <div class="sub">å›åå…¥åŠ›å¾Œã«ç¢ºå®š</div>
          </div>
        </div>

        <div class="invest-grid">
          <button class="btn big plus" id="btnPlusA" disabled>ï¼‹46æš</button>
          <button class="btn big plus2" id="btnPlusB" disabled>ï¼‹50æš</button>
        </div>

        <div class="field">
          <div class="label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
          <textarea id="runMemo" placeholder="ä¾‹ï¼šå¤©äº•ç‹™ã„ 520Gã€œ / ã‚¾ãƒ¼ãƒ³ç‹™ã„ / æ®ãˆç½®ãæ¿ƒåš ãªã©"></textarea>
          <div class="hint">â€» MVPã§ã¯ã€ãƒ¡ãƒ¢ã¯ãƒ­ã‚°ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆä¸€è¦§ã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰ã€‚</div>
        </div>
      </div>

      <div class="card">
        <div class="value">ç¨¼åƒé–‹å§‹ï¼ˆåº—èˆ—é¸æŠï¼‰</div>
        <div class="hint">åº—èˆ—ã‚’é¸ã¶ã¨ã‚¿ã‚¤ãƒãƒ¼ãŒé–‹å§‹ã—ã¾ã™ã€‚</div>

        <div class="field">
          <div class="label">åº—èˆ—</div>
          <select id="startShopSelect"></select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary grow" id="btnStartRun">ã“ã®åº—èˆ—ã§é–‹å§‹</button>
          <button class="btn btn-ghost" id="btnQuickAddShop">ï¼‹ åº—èˆ—è¿½åŠ </button>
        </div>

        <div class="hr"></div>
        <div class="hint">
          ãƒ«ãƒ¼ãƒ«ï¼ˆMVPï¼‰ï¼š
          <br>ãƒ»æŠ•è³‡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãŸã³ã«ã€Œè²¸å‡ºå˜ä½ï¼ˆ46/50ï¼‰ã€åˆ†ã®æŠ•è³‡ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚
          <br>ãƒ»åº—èˆ—ã®è²¯ãƒ¡ãƒ€ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹é–“ã¯å„ªå…ˆçš„ã«æ¶ˆè²»ã•ã‚Œã€è¶³ã‚Šãªã„åˆ†ã ã‘ç¾é‡‘æŠ•è³‡ã«å›ã‚Šã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- LOGS -->
    <section id="viewLogs" class="view">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="value">ç¨¼åƒãƒ­ã‚°</div>
            <div class="hint">ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ãƒå±‹ã«ã„ã‚‹æ™‚é–“ã®æ™‚çµ¦ï¼‰/ å°ãƒ­ã‚°ï¼ˆè©³ç´°ï¼‰</div>
          </div>
          <button class="btn btn-ghost btn-mini" id="btnExport">JSONè¡¨ç¤º</button>
        </div>
        <div class="hr"></div>

        <div class="value" style="font-size:15px;">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§</div>
        <div class="hint">å®¶ã‚’å‡ºã¦ã‹ã‚‰å¸°å®…ã¾ã§ï¼ˆç§»å‹•å«ã‚€ï¼‰ã€‚ã“ã®æ™‚é–“ã§å‡ã—ãŸæ™‚çµ¦ã‚’è¦‹ã¾ã™ã€‚</div>
        <div id="sessionList" class="list"></div>
        <div id="sessionEmpty" class="hint" style="margin-top:10px; display:none;">
          ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã€â†’ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã€ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </div>

        <div class="hr"></div>
        <div class="value" style="font-size:15px;">å°ãƒ­ã‚°</div>
        <div class="hint">å°ã”ã¨ã®åæ”¯ãƒ¡ãƒ¢ç”¨ï¼ˆæ™‚çµ¦ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§è¦‹ã‚‹ï¼‰ã€‚</div>
        <div id="logList" class="list"></div>
        <div id="logEmpty" class="hint" style="margin-top:10px; display:none;">
          ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã¾ãŸã¯ç¨¼åƒã‚¿ãƒ–ã‹ã‚‰ç¨¼åƒã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
    </section>
  </div>

  <!-- åº—èˆ—è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="shopModalBackdrop" aria-hidden="true">
    <div class="modal">
      <h3>åº—èˆ—è¿½åŠ </h3>
      <div class="field">
        <div class="label">åº—èˆ—å</div>
        <input id="shopNameInput" placeholder="ä¾‹ï¼šâ—‹â—‹åº—" />
      </div>
      <div class="field">
        <div class="label">è²¸å‡ºå˜ä½ï¼ˆ1000å††ã‚ãŸã‚Šï¼‰</div>
        <select id="shopUnitSelect">
          <option value="46">46æš</option>
          <option value="50">50æš</option>
        </select>
      </div>
      <div class="field">
        <div class="label">ç¾åœ¨ã®è²¯ãƒ¡ãƒ€ãƒ«ï¼ˆæšï¼‰</div>
        <input id="shopMedalsInput" inputmode="numeric" placeholder="ä¾‹ï¼š1200" />
        <div class="hint">â€» åŠè§’æ•°å­—ã§å…¥åŠ›ã€‚ç©ºæ¬„ã¯0æšæ‰±ã„ã€‚</div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost grow" id="btnCloseShopModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary grow" id="btnSaveShop">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- çµ‚äº†å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="endModalBackdrop" aria-hidden="true">
    <div class="modal">
      <h3>ç¨¼åƒçµ‚äº†</h3>
      <div class="hint">å›åæšæ•°ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å·®æšãƒ»å®Ÿè³ªåæ”¯ãƒ»æ™‚çµ¦ãŒç¢ºå®šã—ã¾ã™ã€‚</div>

      <div class="field">
        <div class="label">å›åæšæ•°ï¼ˆæšï¼‰</div>
        <input id="endCollectInput" inputmode="numeric" placeholder="ä¾‹ï¼š1850" />
      </div>

      <div class="card" style="margin-top:12px; background: rgba(11,15,20,.35); box-shadow:none;">
        <div class="kpis" style="grid-template-columns: 1fr 1fr;">
          <div class="kpi" style="background: rgba(15,23,36,.55); box-shadow:none;">
            <div class="label">å·®æš</div>
            <div id="endDiff" class="value mono">0æš</div>
          </div>
          <div class="kpi" style="background: rgba(15,23,36,.55); box-shadow:none;">
            <div class="label">å®Ÿè³ªåæ”¯ï¼ˆå††ï¼‰</div>
            <div id="endNetYen" class="value mono">0å††</div>
          </div>
          <div class="kpi" style="background: rgba(15,23,36,.55); box-shadow:none;">
            <div class="label">ç¨¼åƒæ™‚é–“</div>
            <div id="endTime" class="value mono">0:00:00</div>
          </div>
          <div class="kpi" style="background: rgba(15,23,36,.55); box-shadow:none;">
            <div class="label">æ™‚çµ¦</div>
            <div id="endHourly" class="value mono">0å††/h</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-ghost grow" id="btnCancelEnd">æˆ»ã‚‹</button>
        <button class="btn btn-primary grow" id="btnConfirmEnd">ä¿å­˜ã—ã¦çµ‚äº†</button>
      </div>
      <div class="hint" style="margin-top:10px;">
        â€» å®Ÿè³ªåæ”¯ï¼ˆå††ï¼‰ã¯ã€Œå·®æš Ã· è²¸å‡ºå˜ä½ Ã— 1000å††ã€ã§è¨ˆç®—ï¼ˆMVPã®ç°¡æ˜“æ›ç®—ï¼‰ã€‚
        <br>â€» ãƒ—ãƒ­ãŒè¦‹ã‚‹æ™‚çµ¦ã¯ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ãƒå±‹ã«ã„ã‚‹æ™‚é–“ï¼‰ã€ã§å‡ã—ãŸæ™‚çµ¦ã§ã™ã€‚å°ãƒ­ã‚°ã®æ™‚çµ¦è¡¨ç¤ºã¯å‚è€ƒæ‰±ã„ã€‚
      </div>
    </div>
  </div>

  <!-- JSONè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="jsonModalBackdrop" aria-hidden="true">
    <div class="modal">
      <h3>ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰</h3>
      <div class="hint">ã‚³ãƒ”ãƒ¼ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ãã¾ã™ï¼ˆMVPï¼‰ã€‚</div>
      <div class="field">
        <textarea id="jsonArea" class="mono" style="min-height:180px;"></textarea>
      </div>
      <div class="actions">
        <button class="btn btn-ghost grow" id="btnCloseJson">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary grow" id="btnCopyJson">ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * æŠ•è³‡ãƒ¯ã‚«ãƒ¼ãƒ«å› ver0.1ï¼ˆMVPï¼‰
     */

    // ---------- storage keys ----------
    const KEY_SHOPS    = "iwk_shops_v1";
    const KEY_LOGS     = "iwk_logs_v1";
    const KEY_RUN      = "iwk_active_run_v1";      // å°ã®ç¨¼åƒï¼ˆ1å°ï¼‰
    const KEY_SESSION  = "iwk_active_session_v1";  // ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ç¨¼åƒï¼ˆå®¶å‡ºã‚‹ã€œå¸°å®…ï¼‰
    const KEY_SESSIONS = "iwk_sessions_v1";        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´

    // ---------- helpers ----------
    const $ = (sel) => document.querySelector(sel);

    function nowYMD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function fmtTimeHMS(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${hh}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
    }
    function fmtTimeHM(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const hh = Math.floor(s/3600);
      const mm = Math.floor((s%3600)/60);
      return `${hh}:${String(mm).padStart(2,"0")}`;
    }
    function yen(n){
      const v = Math.round(n);
      return v.toLocaleString("ja-JP") + "å††";
    }
    function medals(n){
      const v = Math.round(n);
      return v.toLocaleString("ja-JP") + "æš";
    }
    function clampInt(v, def=0){
      const n = parseInt(String(v).replace(/[^\d-]/g,""), 10);
      return Number.isFinite(n) ? n : def;
    }
    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){
        return fallback;
      }
    }
    function saveJSON(key, obj){
      localStorage.setItem(key, JSON.stringify(obj));
    }
    function uuid(){
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ---------- state ----------
    let shops = loadJSON(KEY_SHOPS, []);
    let logs  = loadJSON(KEY_LOGS, []);
    let sessions = loadJSON(KEY_SESSIONS, []);
    let activeSession = loadJSON(KEY_SESSION, null);
    let activeRun = loadJSON(KEY_RUN, null);
    let timerId = null;

    // ---------- DOM refs ----------
    const todayPill = $("#todayPill");

    const tabs = document.querySelectorAll(".tab");
    const viewHome = $("#viewHome");
    const viewRun  = $("#viewRun");
    const viewLogs = $("#viewLogs");

    // home
    const homeStatus = $("#homeStatus");
    const homeStatusHint = $("#homeStatusHint");
    const btnOpenStart = $("#btnOpenStart");
    const btnSessionToggle = $("#btnSessionToggle");
    const btnOpenShopModal = $("#btnOpenShopModal");
    const btnResetAll = $("#btnResetAll");
    const shopListEl = $("#shopList");
    const shopEmpty = $("#shopEmpty");

    // KPI
    const kpiTotalDiff = $("#kpiTotalDiff");
    const kpiAvgHourly = $("#kpiAvgHourly");
    const kpiTotalTime = $("#kpiTotalTime");
    const kpiCount = $("#kpiCount");

    // run
    const startShopSelect = $("#startShopSelect");
    const btnStartRun = $("#btnStartRun");
    const btnQuickAddShop = $("#btnQuickAddShop");

    const runShopName = $("#runShopName");
    const runUnit = $("#runUnit");
    const runElapsed = $("#runElapsed");
    const runStartAt = $("#runStartAt");
    const btnEndRun = $("#btnEndRun");

    const runInvestMedals = $("#runInvestMedals");
    const runCashYen = $("#runCashYen");
    const runShopMedals = $("#runShopMedals");
    const runLiveDiff = $("#runLiveDiff");

    const btnPlusA = $("#btnPlusA");
    const btnPlusB = $("#btnPlusB");
    const runMemo = $("#runMemo");

    // logs
    const logListEl = $("#logList");
    const logEmpty = $("#logEmpty");
    const sessionListEl = $("#sessionList");
    const sessionEmpty = $("#sessionEmpty");
    const btnExport = $("#btnExport");

    // modals
    const shopModalBackdrop = $("#shopModalBackdrop");
    const btnCloseShopModal = $("#btnCloseShopModal");
    const btnSaveShop = $("#btnSaveShop");
    const shopNameInput = $("#shopNameInput");
    const shopUnitSelect = $("#shopUnitSelect");
    const shopMedalsInput = $("#shopMedalsInput");

    const endModalBackdrop = $("#endModalBackdrop");
    const endCollectInput = $("#endCollectInput");
    const endDiff = $("#endDiff");
    const endNetYen = $("#endNetYen");
    const endTime = $("#endTime");
    const endHourly = $("#endHourly");
    const btnCancelEnd = $("#btnCancelEnd");
    const btnConfirmEnd = $("#btnConfirmEnd");

    const jsonModalBackdrop = $("#jsonModalBackdrop");
    const jsonArea = $("#jsonArea");
    const btnCloseJson = $("#btnCloseJson");
    const btnCopyJson = $("#btnCopyJson");

    // ---------- view switch ----------
    function showView(name){
      tabs.forEach(t=>{
        const selected = (t.dataset.view === name);
        t.setAttribute("aria-selected", selected ? "true":"false");
      });

      viewHome.classList.toggle("active", name==="home");
      viewRun.classList.toggle("active", name==="run");
      viewLogs.classList.toggle("active", name==="logs");

      if(name==="home") renderHome();
      if(name==="run")  renderRun();
      if(name==="logs") renderLogs();
    }
    tabs.forEach(t => t.addEventListener("click", ()=> showView(t.dataset.view)));

    // ---------- modal helpers ----------
    function openModal(backdrop){
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden","false");
    }
    function closeModal(backdrop){
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden","true");
    }
    [shopModalBackdrop, endModalBackdrop, jsonModalBackdrop].forEach(b=>{
      b.addEventListener("click",(e)=>{
        if(e.target === b) closeModal(b);
      });
    });

    // ---------- session (timecard) ----------
    function sessionElapsedMs(){
      if(!activeSession) return 0;
      return Date.now() - activeSession.startTs;
    }
    function currentSessionAgg(){
      if(!activeSession) return { totalDiff:0, totalYen:0, hours:0, hourly:0 };
      const sid = activeSession.id;
      const totalDiff = logs.reduce((a,l)=> a + ((l.sessionId===sid)?(l.diffMedals||0):0), 0);
      const totalYen  = logs.reduce((a,l)=> a + ((l.sessionId===sid)?(l.netYen||0):0), 0);
      const hours = sessionElapsedMs() / (1000*60*60);
      const hourly = hours>0 ? (totalYen / hours) : 0;
      return { totalDiff, totalYen, hours, hourly };
    }
    function updateSessionButton(){
      if(activeSession){
        btnSessionToggle.textContent = "ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†";
        btnSessionToggle.classList.add("btn-danger");
        btnSessionToggle.classList.remove("btn-primary");
      }else{
        btnSessionToggle.textContent = "ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹";
        btnSessionToggle.classList.remove("btn-danger");
        btnSessionToggle.classList.add("btn-primary");
      }
    }

    btnSessionToggle.addEventListener("click", ()=>{
      // çµ‚äº†
      if(activeSession){
        if(activeRun){
          alert("å°ã®ç¨¼åƒä¸­ã§ã™ã€‚å…ˆã«ã€ç¨¼åƒçµ‚äº†ï¼ˆå°ï¼‰ã€ã—ã¦ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const agg = currentSessionAgg();
        const endTs = Date.now();
        const elapsedMs = endTs - activeSession.startTs;

        const session = {
          id: activeSession.id,
          date: nowYMD(),
          startTs: activeSession.startTs,
          endTs,
          elapsedMs,
          totalDiffMedals: agg.totalDiff,
          totalNetYen: agg.totalYen,
          hourlyYen: agg.hourly
        };
        sessions.unshift(session);
        saveJSON(KEY_SESSIONS, sessions);

        activeSession = null;
        saveJSON(KEY_SESSION, null);

        renderAll();
        showView("logs");
        return;
      }

      // é–‹å§‹
      activeSession = { id: uuid(), startTs: Date.now() };
      saveJSON(KEY_SESSION, activeSession);
      renderAll();
      showView("run");
    });

    function renderSessions(){
      sessionListEl.innerHTML = "";
      if(!sessions || sessions.length===0){
        sessionEmpty.style.display = "block";
        return;
      }
      sessionEmpty.style.display = "none";

      sessions.forEach(s=>{
        const hourlyCls = (s.hourlyYen||0) >= 0 ? "good":"bad";
        const diffCls = (s.totalDiffMedals||0) >= 0 ? "good":"bad";

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-top">
            <div>
              <div class="value" style="font-size:16px;">${escapeHtml(s.date)} ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
              <div class="hint">ç¨¼åƒ <span class="mono">${fmtTimeHMS(s.elapsedMs||0)}</span> ãƒ»æ™‚çµ¦ <span class="mono ${hourlyCls}">${yen(s.hourlyYen||0)}/h</span></div>
            </div>
            <div class="right">
              <div class="badge">ğŸ†” <span class="mono">${String(s.id).slice(-6)}</span></div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="label">ç·å·®æš</div>
              <div class="value mono ${diffCls}">${medals(s.totalDiffMedals||0)}</div>
            </div>
            <div class="right">
              <div class="label">ç·åæ”¯ï¼ˆç°¡æ˜“ï¼‰</div>
              <div class="value mono ${(s.totalNetYen||0)>=0?"good":"bad"}">${yen(s.totalNetYen||0)}</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:flex-end;">
            <button class="btn btn-danger btn-mini" data-act="del">å‰Šé™¤</button>
          </div>
        `;
        el.querySelector('[data-act="del"]').addEventListener("click", ()=>{
          if(confirm("ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã²ã‚‚ã¥ãå°ãƒ­ã‚°ã¯æ®‹ã‚Šã¾ã™ï¼ˆMVPï¼‰ã€‚")){
            sessions = sessions.filter(x=>x.id !== s.id);
            saveJSON(KEY_SESSIONS, sessions);
            renderAll();
          }
        });
        sessionListEl.appendChild(el);
      });
    }

    // ---------- shops ----------
    function getShopById(id){
      return shops.find(s=>s.id === id) || null;
    }

    function renderShopList(){
      shopListEl.innerHTML = "";
      if(shops.length === 0){
        shopEmpty.style.display = "block";
        return;
      }
      shopEmpty.style.display = "none";

      shops.forEach(shop=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-top">
            <div>
              <div class="value" style="font-size:16px;">${escapeHtml(shop.name)}</div>
              <div class="hint">è²¸å‡º <span class="mono">${shop.unit}</span>æš / è²¯ãƒ¡ãƒ€ãƒ« <span class="mono">${medals(shop.medals)}</span></div>
            </div>
            <div class="right">
              <button class="btn btn-ghost btn-mini" data-act="edit">ç·¨é›†</button>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between;">
            <div class="badge">ID <span class="mono">${shop.id.slice(-6)}</span></div>
            <button class="btn btn-danger btn-mini" data-act="del">å‰Šé™¤</button>
          </div>
        `;

        el.querySelector('[data-act="edit"]').addEventListener("click", ()=> openShopModal(shop));
        el.querySelector('[data-act="del"]').addEventListener("click", ()=>{
          if(confirm(`ã€Œ${shop.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» è²¯ãƒ¡ãƒ€ãƒ«ç®¡ç†ã‚‚æ¶ˆãˆã¾ã™`)){
            if(activeRun && activeRun.shopId === shop.id){
              alert("ã“ã®åº—èˆ—ã¯ç¨¼åƒä¸­ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚ç¨¼åƒã‚’çµ‚äº†ã—ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
              return;
            }
            shops = shops.filter(s=>s.id !== shop.id);
            saveJSON(KEY_SHOPS, shops);
            renderAll();
          }
        });

        shopListEl.appendChild(el);
      });
    }

    function openShopModal(editShop=null){
      shopModalBackdrop.dataset.editId = editShop ? editShop.id : "";
      shopNameInput.value = editShop ? editShop.name : "";
      shopUnitSelect.value = editShop ? String(editShop.unit) : "46";
      shopMedalsInput.value = editShop ? String(editShop.medals) : "";
      openModal(shopModalBackdrop);
      setTimeout(()=> shopNameInput.focus(), 50);
    }

    btnOpenShopModal.addEventListener("click", ()=> openShopModal(null));
    btnQuickAddShop.addEventListener("click", ()=> openShopModal(null));
    btnCloseShopModal.addEventListener("click", ()=> closeModal(shopModalBackdrop));

    btnSaveShop.addEventListener("click", ()=>{
      const name = shopNameInput.value.trim();
      const unit = clampInt(shopUnitSelect.value, 46);
      const medalsVal = clampInt(shopMedalsInput.value, 0);

      if(!name){ alert("åº—èˆ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if(unit !== 46 && unit !== 50){ alert("è²¸å‡ºå˜ä½ã¯46æšã¾ãŸã¯50æšã§ã™ã€‚"); return; }
      if(medalsVal < 0){ alert("è²¯ãƒ¡ãƒ€ãƒ«ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

      const editId = shopModalBackdrop.dataset.editId || "";
      if(editId){
        shops = shops.map(s => s.id !== editId ? s : ({ ...s, name, unit, medals: medalsVal }));
      }else{
        shops.push({ id: uuid(), name, unit, medals: medalsVal });
      }
      saveJSON(KEY_SHOPS, shops);
      closeModal(shopModalBackdrop);
      renderAll();
    });

    // ---------- run ----------
    function refreshStartShopSelect(){
      startShopSelect.innerHTML = "";
      if(shops.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆè¿½åŠ ã—ã¦ãã ã•ã„ï¼‰";
        startShopSelect.appendChild(opt);
        startShopSelect.disabled = true;
        btnStartRun.disabled = true;
        return;
      }
      startShopSelect.disabled = false;
      btnStartRun.disabled = false;

      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "åº—èˆ—ã‚’é¸æŠ...";
      startShopSelect.appendChild(placeholder);

      shops.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name}ï¼ˆ${s.unit}æš / è²¯${s.medals}æšï¼‰`;
        startShopSelect.appendChild(opt);
      });
    }

    btnOpenStart.addEventListener("click", ()=>{
      showView("run");
      if(!activeRun){
        setTimeout(()=> startShopSelect.focus(), 80);
      }
    });

    btnStartRun.addEventListener("click", ()=>{
      if(activeRun){ alert("ã™ã§ã«ç¨¼åƒä¸­ã§ã™ã€‚çµ‚äº†ã—ã¦ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„ã€‚"); return; }
      if(!activeSession){
        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nå…ˆã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã€ã—ã¦ãã ã•ã„ï¼ˆå®¶ã‚’å‡ºãŸæ™‚ç‚¹ã€œå¸°å®…ã¾ã§ã‚’æ¸¬ã‚‹ï¼‰ã€‚");
        return;
      }
      const shopId = startShopSelect.value;
      if(!shopId){ alert("åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const shop = getShopById(shopId);
      if(!shop){ alert("åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return; }

      activeRun = {
        id: uuid(),
        sessionId: activeSession.id,
        date: nowYMD(),
        shopId: shop.id,
        shopName: shop.name,
        unit: shop.unit,
        startTs: Date.now(),
        investMedals: 0,
        replayUsed: 0,
        cashLoans: 0,
        collectMedals: null,
        memo: ""
      };
      saveJSON(KEY_RUN, activeRun);

      renderRun();
      showView("run");
    });

    function startTimer(){
      stopTimer();
      timerId = setInterval(()=>{
        if(!activeRun) return;
        const elapsed = Date.now() - activeRun.startTs;
        runElapsed.textContent = fmtTimeHMS(elapsed);
      }, 250);
    }
    function stopTimer(){
      if(timerId){ clearInterval(timerId); timerId = null; }
    }

    function addInvestment(amount){
      if(!activeRun) return;
      const shop = getShopById(activeRun.shopId);
      if(!shop){
        alert("åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç¨¼åƒã‚’çµ‚äº†ã§ãã¾ã›ã‚“ã€‚");
        return;
      }

      activeRun.investMedals += amount;

      const useReplay = Math.min(shop.medals, amount);
      shop.medals -= useReplay;
      activeRun.replayUsed += useReplay;

      const remain = amount - useReplay;
      if(remain > 0){
        activeRun.cashLoans += 1; // 1000å††è²¸å‡º1å›
      }

      saveJSON(KEY_RUN, activeRun);
      saveJSON(KEY_SHOPS, shops);

      renderRunStats();
      renderHome();
    }

    btnPlusA.addEventListener("click", ()=> addInvestment(46));
    btnPlusB.addEventListener("click", ()=> addInvestment(50));

    btnEndRun.addEventListener("click", ()=>{
      if(!activeRun) return;
      openEndModal();
    });

    function openEndModal(){
      endCollectInput.value = "";
      endDiff.textContent = medals(0);
      endNetYen.textContent = yen(0);
      endTime.textContent = fmtTimeHMS(Date.now() - activeRun.startTs);
      endHourly.textContent = yen(0) + "/h";
      openModal(endModalBackdrop);
      setTimeout(()=> endCollectInput.focus(), 50);
    }

    endCollectInput.addEventListener("input", ()=>{
      if(!activeRun) return;
      const collect = clampInt(endCollectInput.value, 0);
      const diff = collect - activeRun.investMedals;
      const net = (diff / activeRun.unit) * 1000;
      const elapsedMs = Date.now() - activeRun.startTs;
      const hours = elapsedMs / (1000*60*60);
      const hourly = hours > 0 ? (net / hours) : 0;

      endDiff.textContent = medals(diff);
      endDiff.classList.toggle("good", diff >= 0);
      endDiff.classList.toggle("bad", diff < 0);

      endNetYen.textContent = yen(net);
      endNetYen.classList.toggle("good", net >= 0);
      endNetYen.classList.toggle("bad", net < 0);

      endTime.textContent = fmtTimeHMS(elapsedMs);

      endHourly.textContent = yen(hourly) + "/h";
      endHourly.classList.toggle("good", hourly >= 0);
      endHourly.classList.toggle("bad", hourly < 0);
    });

    btnCancelEnd.addEventListener("click", ()=> closeModal(endModalBackdrop));

    btnConfirmEnd.addEventListener("click", ()=>{
      if(!activeRun) return;

      const collect = clampInt(endCollectInput.value, -1);
      if(collect < 0){ alert("å›åæšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

      const shop = getShopById(activeRun.shopId);
      if(!shop){ alert("åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); return; }

      shop.medals = (shop.medals || 0) + collect;
      saveJSON(KEY_SHOPS, shops);

      const endTs = Date.now();
      const elapsedMs = endTs - activeRun.startTs;
      const diff = collect - activeRun.investMedals;
      const netYen = (diff / activeRun.unit) * 1000;
      const hours = elapsedMs / (1000*60*60);
      const hourly = hours > 0 ? (netYen / hours) : 0;

      activeRun.memo = runMemo.value.trim();
      activeRun.collectMedals = collect;

      const log = {
        id: activeRun.id,
        sessionId: activeRun.sessionId,
        date: activeRun.date,
        shopId: activeRun.shopId,
        shopName: activeRun.shopName,
        unit: activeRun.unit,
        startTs: activeRun.startTs,
        endTs,
        elapsedMs,
        investMedals: activeRun.investMedals,
        replayUsed: activeRun.replayUsed,
        cashLoans: activeRun.cashLoans,
        collectMedals: collect,
        diffMedals: diff,
        netYen,
        hourlyYen: hourly,
        memo: activeRun.memo
      };

      logs.unshift(log);
      saveJSON(KEY_LOGS, logs);

      activeRun = null;
      saveJSON(KEY_RUN, null);
      stopTimer();

      closeModal(endModalBackdrop);
      runMemo.value = "";
      renderAll();
      showView("logs");
    });

    function renderRunStats(){
      if(!activeRun){
        runInvestMedals.textContent = medals(0);
        runCashYen.textContent = yen(0);
        runShopMedals.textContent = medals(0);
        runLiveDiff.textContent = medals(0);
        return;
      }
      const shop = getShopById(activeRun.shopId);
      runInvestMedals.textContent = medals(activeRun.investMedals);
      runCashYen.textContent = yen(activeRun.cashLoans * 1000);
      runShopMedals.textContent = medals(shop ? shop.medals : 0);
      runLiveDiff.textContent = medals(0);
    }

    function renderRun(){
      refreshStartShopSelect();

      if(activeRun){
        const shop = getShopById(activeRun.shopId);
        runShopName.textContent = shop ? shop.name : activeRun.shopName;
        runUnit.textContent = String(activeRun.unit);
        runStartAt.textContent = new Date(activeRun.startTs).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});
        btnEndRun.disabled = false;

        btnPlusA.disabled = false;
        btnPlusB.disabled = false;
        btnPlusA.textContent = "ï¼‹46æš";
        btnPlusB.textContent = "ï¼‹50æš";

        renderRunStats();
        startTimer();
      }else{
        runShopName.textContent = "æœªé–‹å§‹";
        runUnit.textContent = "-";
        runStartAt.textContent = "-";
        runElapsed.textContent = "0:00:00";
        btnEndRun.disabled = true;
        btnPlusA.disabled = true;
        btnPlusB.disabled = true;
        renderRunStats();
        stopTimer();
      }
    }

    // ---------- logs ----------

    function renderLogs(){
      logListEl.innerHTML = "";
      if(logs.length === 0){
        logEmpty.style.display = "block";
      }else{
        logEmpty.style.display = "none";
      }

      logs.forEach(l=>{
        const diffCls = (l.diffMedals||0) >= 0 ? "good":"bad";
        const netCls  = (l.netYen||0) >= 0 ? "good":"bad";
        const hourlyCls = (l.hourlyYen||0) >= 0 ? "good":"bad";

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-top">
            <div>
              <div class="value" style="font-size:16px;">${escapeHtml(l.shopName)}</div>
              <div class="hint">
                <span class="mono">${escapeHtml(l.date)}</span>
                ãƒ»ç¨¼åƒ <span class="mono">${fmtTimeHMS(l.elapsedMs||0)}</span>
                ãƒ»è²¸å‡º <span class="mono">${l.unit}</span>æš
              </div>
            </div>
            <div class="right">
              <div class="badge">ğŸ†” <span class="mono">${String(l.id).slice(-6)}</span></div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between;">
            <div>
              <div class="label">å·®æš</div>
              <div class="value mono ${diffCls}">${medals(l.diffMedals||0)}</div>
            </div>
            <div class="right">
              <div class="label">å®Ÿè³ªåæ”¯</div>
              <div class="value mono ${netCls}">${yen(l.netYen||0)}</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:space-between;">
            <div class="badge">æŠ•è³‡ <span class="mono">${medals(l.investMedals||0)}</span></div>
            <div class="badge">å›å <span class="mono">${medals(l.collectMedals||0)}</span></div>
            <div class="badge">å°æ™‚çµ¦(å‚è€ƒ) <span class="mono ${hourlyCls}">${yen(l.hourlyYen||0)}/h</span></div>
          </div>
          <div class="hr"></div>
          <div class="row" style="justify-content:flex-end;">
            <button class="btn btn-danger btn-mini" data-del-log="${escapeHtml(l.id)}">å‰Šé™¤</button>
          </div>
        `;
        // Add per-item delete handler
        const delBtn = el.querySelector("button[data-del-log]");
        if (delBtn) {
          delBtn.addEventListener("click", () => {
            const id = delBtn.getAttribute("data-del-log");
            const target = logs.find(x => x.id === id);
            if (!target) return;
            if (confirm("ã“ã®å°ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
              logs = logs.filter(x => x.id !== id);
              saveJSON(KEY_LOGS, logs);
              renderAll();
            }
          });
        }
        logListEl.appendChild(el);
      });

      renderSessions();
    }

    // ---------- home KPI ----------
    function renderKPIs(){
      const totalDiff = logs.reduce((a,l)=> a + (l.diffMedals || 0), 0);
      const totalMs = logs.reduce((a,l)=> a + (l.elapsedMs || 0), 0);
      const totalYen = logs.reduce((a,l)=> a + (l.netYen || 0), 0);
      const totalHours = totalMs / (1000*60*60);
      const avgHourly = totalHours > 0 ? (totalYen / totalHours) : 0;

      kpiTotalDiff.textContent = medals(totalDiff);
      kpiTotalDiff.classList.toggle("good", totalDiff >= 0);
      kpiTotalDiff.classList.toggle("bad", totalDiff < 0);

      kpiTotalTime.textContent = fmtTimeHM(totalMs);
      kpiAvgHourly.textContent = yen(avgHourly) + "/h";
      kpiAvgHourly.classList.toggle("good", avgHourly >= 0);
      kpiAvgHourly.classList.toggle("bad", avgHourly < 0);

      kpiCount.textContent = `${logs.length}ä»¶`;
    }

    function renderHome(){
      if(activeSession){
        homeStatus.textContent = "ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­";
        const agg = currentSessionAgg();
        const elapsed = sessionElapsedMs();
        homeStatusHint.textContent =
          `çµŒéï¼š${fmtTimeHMS(elapsed)} / ç·å·®æšï¼š${medals(agg.totalDiff)} / ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚çµ¦ï¼š${yen(agg.hourly)}/h`;
      }else{
        homeStatus.textContent = "æœªé–‹å§‹";
        homeStatusHint.textContent = "å®¶ã‚’å‡ºãŸã‚‰ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã€ã€‚å¸°å®…ã—ãŸã‚‰ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã€ã€‚";
      }
      renderShopList();
      renderKPIs();
      updateSessionButton();
    }

    // ---------- export JSON ----------
    btnExport.addEventListener("click", ()=>{
      const data = {
        version: "0.1",
        exportedAt: new Date().toISOString(),
        shops,
        sessions,
        logs,
        activeSession,
        activeRun
      };
      jsonArea.value = JSON.stringify(data, null, 2);
      openModal(jsonModalBackdrop);
    });
    btnCloseJson.addEventListener("click", ()=> closeModal(jsonModalBackdrop));
    btnCopyJson.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(jsonArea.value);
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
      }catch(e){
        alert("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§ã¯éå¯¾å¿œã®å¯èƒ½æ€§ï¼‰ã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
      }
    });

    // ---------- reset all ----------
    btnResetAll.addEventListener("click", ()=>{
      if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆåº—èˆ—ãƒ»ãƒ­ã‚°ãƒ»ç¨¼åƒä¸­ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» å…ƒã«æˆ»ã›ã¾ã›ã‚“")) return;

      try{
        localStorage.removeItem(KEY_SHOPS);
        localStorage.removeItem(KEY_LOGS);
        localStorage.removeItem(KEY_RUN);
        localStorage.removeItem(KEY_SESSIONS);
        localStorage.removeItem(KEY_SESSION);
      }catch(e){}

      shops = [];
      logs = [];
      sessions = [];
      activeSession = null;
      activeRun = null;
      stopTimer();

      try{
        saveJSON(KEY_SHOPS, shops);
        saveJSON(KEY_LOGS, logs);
        saveJSON(KEY_RUN, activeRun);
        saveJSON(KEY_SESSIONS, sessions);
        saveJSON(KEY_SESSION, activeSession);
      }catch(e){}

      renderAll();
      showView("home");
    });

    // ---------- init ----------
    function renderAll(){
      todayPill.textContent = `ğŸ“… ${nowYMD()}`;
      renderHome();
      renderRun();
      renderLogs();
      renderSessions();
      updateSessionButton();
    }

    function boot(){
      todayPill.textContent = `ğŸ“… ${nowYMD()}`;

      activeRun = loadJSON(KEY_RUN, null);
      shops = loadJSON(KEY_SHOPS, []);
      logs  = loadJSON(KEY_LOGS, []);
      sessions = loadJSON(KEY_SESSIONS, []);
      activeSession = loadJSON(KEY_SESSION, null);

      if(activeRun && !getShopById(activeRun.shopId)){
        alert("ç¨¼åƒä¸­ãƒ‡ãƒ¼ã‚¿ã®åº—èˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ç¨¼åƒä¸­çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
        activeRun = null;
        saveJSON(KEY_RUN, null);
      }

      renderAll();
      if(activeRun) showView("run");
      else showView("home");
    }

    boot();
  </script>
</body>
</html>
